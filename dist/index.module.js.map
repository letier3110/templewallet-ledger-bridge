{"version":3,"file":"index.module.js","sources":["../src/types.ts","../src/client.ts"],"sourcesContent":["export type BridgeRequest = BridgeExchangeRequest;\n\nexport type BridgeResponse = BridgeExchangeResponse | BridgeErrorResponse;\n\nexport interface BridgeExchangeRequest extends BridgeMessageBase {\n  type: BridgeMessageType.ExchangeRequest;\n  apdu: string;\n  scrambleKey?: string;\n  exchangeTimeout?: number;\n}\n\nexport interface BridgeExchangeResponse extends BridgeMessageBase {\n  type: BridgeMessageType.ExchangeResponse;\n  result: string;\n}\n\nexport interface BridgeErrorResponse extends BridgeMessageBase {\n  type: BridgeMessageType.ErrorResponse;\n  message: string;\n}\n\nexport interface BridgeMessageBase {\n  type: BridgeMessageType;\n}\n\nexport enum BridgeMessageType {\n  ExchangeRequest = \"THANOS_LEDGER_BRIDGE_EXCHANGE_REQUEST\",\n  ExchangeResponse = \"THANOS_LEDGER_BRIDGE_EXCHANGE_RESPONSE\",\n  ErrorResponse = \"THANOS_LEDGER_ERROR_RESPONSE\",\n}\n","import Transport from \"@ledgerhq/hw-transport\";\nimport {\n  BridgeExchangeRequest,\n  BridgeMessageType,\n  BridgeResponse,\n} from \"./types\";\n\nexport class LedgerThanosBridgeTransport extends Transport {\n  static async isSupported() {\n    return true;\n  }\n\n  // this transport is not discoverable\n  static async list() {\n    return [];\n  }\n\n  // this transport is not discoverable\n  static listen() {\n    return {\n      unsubscribe: () => {},\n    };\n  }\n\n  static async open() {\n    const bridgeUrl = \"https://thanoswallet.com/ledger-bridge\";\n    const iframe = document.createElement(\"iframe\");\n    iframe.src = bridgeUrl;\n    document.head.appendChild(iframe);\n    return new LedgerThanosBridgeTransport(iframe, bridgeUrl);\n  }\n\n  scrambleKey?: Buffer;\n  unwrap?: boolean;\n\n  constructor(private iframe: HTMLIFrameElement, private bridgeUrl: string) {\n    super();\n  }\n\n  exchange(apdu: Buffer) {\n    return new Promise<Buffer>((resolve, reject) => {\n      const msg: BridgeExchangeRequest = {\n        type: BridgeMessageType.ExchangeRequest,\n        apdu: apdu.toString(),\n        scrambleKey: this.scrambleKey?.toString(),\n        exchangeTimeout: (this as any).exchangeTimeout,\n      };\n      this.iframe.contentWindow?.postMessage(msg, \"*\");\n\n      const handleMessage = (evt: MessageEvent) => {\n        if (evt.origin !== this.getOrigin()) {\n          return;\n        }\n\n        const res: BridgeResponse = evt.data;\n        switch (res?.type) {\n          case BridgeMessageType.ExchangeResponse:\n            resolve(Buffer.from(res.result));\n            break;\n\n          case BridgeMessageType.ErrorResponse:\n            reject(res.message);\n            break;\n        }\n\n        window.removeEventListener(\"message\", handleMessage);\n      };\n\n      window.addEventListener(\"message\", handleMessage);\n    });\n  }\n\n  setScrambleKey(scrambleKey: string) {\n    this.scrambleKey = Buffer.from(scrambleKey, \"ascii\");\n  }\n\n  setUnwrap(unwrap: boolean) {\n    this.unwrap = unwrap;\n  }\n\n  async close() {\n    document.head.removeChild(this.iframe);\n  }\n\n  private getOrigin() {\n    const tmp = this.bridgeUrl.split(\"/\");\n    tmp.splice(-1, 1);\n    return tmp.join(\"/\");\n  }\n}\n"],"names":["BridgeMessageType","LedgerThanosBridgeTransport","iframe","bridgeUrl","_this","isSupported","list","listen","unsubscribe","open","document","createElement","src","head","appendChild","exchange","apdu","Promise","resolve","reject","msg","type","ExchangeRequest","toString","scrambleKey","_this2","_this2$scrambleKey","exchangeTimeout","contentWindow","postMessage","window","addEventListener","handleMessage","evt","origin","getOrigin","res","data","ExchangeResponse","Buffer","from","result","ErrorResponse","message","removeEventListener","setScrambleKey","this","setUnwrap","unwrap","close","removeChild","tmp","split","splice","join","Transport"],"mappings":"sCAyBYA,IAAAA,GAAZ,SAAYA,GACVA,0DACAA,4DACAA,+CAHF,CAAYA,IAAAA,OClBCC,IAAAA,sBA4BX,WAAoBC,EAAmCC,gBACrDC,6BADkBF,EAAmCE,YAAAD,2FA5BzDF,EACeI,uBACX,wBAAO,MAIIC,gBACX,uBAAO,OAIFC,OAAP,WACE,MAAO,CACLC,YAAa,iBAIJC,oBACX,IAAMN,EAAY,yCACZD,EAASQ,SAASC,cAAc,UAGtC,OAFAT,EAAOU,IAAMT,EACbO,SAASG,KAAKC,YAAYZ,mBACnB,IAAID,EAA4BC,EAAQC,IAtBnD,+DAgCEY,SAAA,SAASC,cACP,WAAWC,QAAgB,SAACC,EAASC,WAC7BC,EAA6B,CACjCC,KAAMrB,EAAkBsB,gBACxBN,KAAMA,EAAKO,WACXC,sBAAaC,EAAKD,gCAALE,EAAkBH,WAC/BI,gBAAkBF,EAAaE,2BAEjCF,EAAKvB,OAAO0B,8BAAeC,YAAYT,EAAK,KAqB5CU,OAAOC,iBAAiB,UAnBF,SAAhBC,EAAiBC,GACrB,GAAIA,EAAIC,SAAWT,EAAKU,YAAxB,CAIA,IAAMC,EAAsBH,EAAII,KAChC,OAAQD,MAAAA,SAAAA,EAAKf,MACX,KAAKrB,EAAkBsC,iBACrBpB,EAAQqB,OAAOC,KAAKJ,EAAIK,SACxB,MAEF,KAAKzC,EAAkB0C,cACrBvB,EAAOiB,EAAIO,SAIfb,OAAOc,oBAAoB,UAAWZ,WAO5Ca,eAAA,SAAerB,GACbsB,KAAKtB,YAAce,OAAOC,KAAKhB,EAAa,YAG9CuB,UAAA,SAAUC,GACRF,KAAKE,OAASA,KAGVC,4BACJvC,SAASG,KAAKqC,YAAYJ,KAAK5C,0BA1EnC,sCA6EUiC,UAAA,WACN,IAAMgB,EAAML,KAAK3C,UAAUiD,MAAM,KAEjC,OADAD,EAAIE,QAAQ,EAAG,GACRF,EAAIG,KAAK,SAhF6BC"}